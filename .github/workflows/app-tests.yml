name: Tests Coverage

on:
  workflow_dispatch:
    inputs:
      test_timeout_minutes:
        description: "Timeout test step"
        required: false
        type: number
        default: 10
      report-generator_version:
        description: "Report generator version"
        required: false
        type: string
        default: "5.5.1"

  workflow_call:
    inputs:
      test_timeout_minutes:
        description: "Timeout test step"
        required: false
        type: number
        default: 10
      report-generator_version:
        description: "Report generator version"
        required: false
        type: string
        default: "5.5.1"

jobs:
  run-tests:
    name: Run ${{ matrix.project }} tests
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project:
          - HomeBudget.Accounting.Api.Tests
          - HomeBudget.Components.Categories.Tests
          - HomeBudget.Components.Operations.Tests
          - HomeBudget.Accounting.Api.IntegrationTests

    services:
      docker:
        image: docker:24.0-dind
        options: >-
          --privileged
          --mount type=tmpfs,destination=/var/lib/docker
          --tmpfs /tmp

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Clean Docker space
        if: matrix.project == 'HomeBudget.Accounting.Api.IntegrationTests'
        run: |
          docker system prune -af
          docker network prune -f

      - name: Add coverlet collector
        run: dotnet add ${{ matrix.project }}/${{ matrix.project }}.csproj package coverlet.collector

      - name: Restore
        run: dotnet restore HomeBudgetAccountingApi.sln

      - name: Build
        run: dotnet build HomeBudgetAccountingApi.sln --configuration Release --no-restore

      - name: Run tests for ${{ matrix.project }}
        run: |
          mkdir -p test-results

          dotnet test "${{ matrix.project }}/${{ matrix.project }}.csproj" \
            --configuration Release \
            --no-build \
            --verbosity minimal \
            --settings coverlet.runsettings \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=${{ matrix.project }}.trx" \
            --results-directory test-results
        shell: bash
        timeout-minutes: ${{ inputs.test_timeout_minutes }}

      - name: Prepare test results
        run: |
          # Create a directory for this project's test results
          mkdir -p artifacts/${{ matrix.project }}-test-results

          # Copy TRX file to structured location
          find test-results -name "${{ matrix.project }}.trx" -exec cp {} artifacts/${{ matrix.project }}-test-results/ \;

          # Copy coverage files to structured location
          find test-results -name "coverage.cobertura.xml" -exec cp {} artifacts/${{ matrix.project }}-test-results/coverage.${{ matrix.project }}.xml \;

          echo "Test results prepared for ${{ matrix.project }}"

      - name: Upload test results artifact
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.project }}
          path: artifacts/${{ matrix.project }}-test-results/
          retention-days: 7

      - name: Upload raw coverage files for Sonar
        uses: actions/upload-artifact@v5
        with:
          name: raw-coverage-${{ matrix.project }}
          path: test-results/**/coverage.cobertura.xml
          retention-days: 7

  merge-coverage:
    name: Merge coverage reports (HTML Report)
    runs-on: ubuntu-latest
    needs: run-tests
    if: always()

    steps:
      - uses: actions/checkout@v5

      - uses: actions/download-artifact@v5
        with:
          pattern: raw-coverage-*
          path: raw-coverage-files
          merge-multiple: true

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Install ReportGenerator tool
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool --version ${{ inputs.report-generator_version }}
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Merge coverage reports into HTML
        run: |
          mkdir -p coverage-html-report

          echo "Available coverage files:"
          find raw-coverage-files -name "*.xml" -type f

          # Generate HTML report for human viewing
          reportgenerator \
            -reports:"raw-coverage-files/**/*.cobertura.xml" \
            -targetdir:"coverage-html-report" \
            -reporttypes:"Html;Badges;MarkdownSummary;TextSummary" \
            -historydir:"./coverage-history" \
            -verbosity:Info

          echo "HTML coverage report generated"

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v5
        with:
          name: coverage-html-report
          path: coverage-html-report/
          retention-days: 30

      - name: Display coverage summary
        run: |
          if [ -f "coverage-html-report/Summary.txt" ]; then
            echo "=== Coverage Summary ==="
            cat coverage-html-report/Summary.txt
          fi
