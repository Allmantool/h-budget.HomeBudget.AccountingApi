name: Unit Tests Coverage
on:
  workflow_dispatch:
    inputs:
      test_timeout_minutes:
        description: "Timeout test step"
        required: false
        type: number
        default: 10
      report-generator_version:
        description: "Report generator version"
        required: false
        type: string
        default: "5.4.16"

  workflow_call:
    inputs:
      test_timeout_minutes:
        description: "Timeout test step"
        required: false
        type: number
        default: 10
      report-generator_version:
        description: "Report generator version"
        required: false
        type: string
        default: "5.4.16"

jobs:
  unit-tests:
    name: Run Unit Tests with Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "9.0.x"

      - run: dotnet restore HomeBudgetAccountingApi.sln
      - run: dotnet build HomeBudgetAccountingApi.sln --configuration Release --no-restore

      - name: Run unit tests
        run: |
          mkdir -p test-results coverage
          dotnet test HomeBudgetAccountingApi.sln \
            --configuration Release \
            --no-build \
            --filter "Category!=Integration" \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory "test-results" \
            --collect:"XPlat Code Coverage"
        timeout-minutes: ${{ inputs.test_timeout_minutes }}

      - run: dotnet tool install -g dotnet-reportgenerator-globaltool --version ${{ inputs.report-generator_version }}
      - run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"test-results/**/coverage.cobertura.xml" \
            -targetdir:"coverage" \
            -reporttypes:"Html;Cobertura" \
            -assemblyfilters:"+HomeBudget.*;-*IntegrationTests*;-*Test.Core*"

      - uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-html
          path: coverage/
      - uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-xml
          path: coverage/Cobertura.xml
