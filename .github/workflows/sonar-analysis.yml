name: Quality gate - Sonarqube
on:
  workflow_dispatch:
    inputs:
      pull-request-id:
        description: "Pull request id"
        required: false
        type: number
        default: 0
      tests-artifact-path:
        description: "Tests artifact path"
        required: false
        type: string
        default: "merged-coverage"
      tests-artifact-name:
        description: "Tests artifact name"
        required: false
        type: string
        default: "merged-test-coverage-html"
      sonar-scanner-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "5.14.0"
      java-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "21"

  workflow_call:
    inputs:
      pull-request-id:
        description: "Pull request id"
        required: false
        type: number
        default: 0
      tests-artifact-path:
        description: "Tests artifact path"
        required: false
        type: string
        default: "merged-coverage"
      tests-artifact-name:
        description: "Tests artifact name"
        required: false
        type: string
        default: "merged-test-coverage-html"
      sonar-scanner-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "5.14.0"
      java-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "21"
    secrets:
      SONAR_TOKEN:
        required: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  sonarqube-scan:
    name: Sonar scanning
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Java for SonarQube
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ inputs.java-version }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Download raw coverage files
        uses: actions/download-artifact@v5
        with:
          pattern: raw-coverage-*
          path: raw-coverage-files
          merge-multiple: true

      - name: Download test results
        uses: actions/download-artifact@v5
        with:
          pattern: test-results-*
          path: test-results
          merge-multiple: true

      - name: Install dotnet sonar scanner
        run: |
          dotnet tool install --global dotnet-sonarscanner --version ${{ inputs.sonar-scanner-version }}

      - name: Set environment variables
        shell: bash
        run: |
          echo "GITHUB_REF_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          echo "COVERAGE_FILES=$(find raw-coverage-files -name '*.cobertura.xml' -type f | tr '\n' ',')" >> $GITHUB_ENV
          echo "TEST_RESULTS_FILES=$(find test-results -name '*.trx' -type f | tr '\n' ',')" >> $GITHUB_ENV

      - name: Display coverage files info
        run: |
          echo "Found coverage files:"
          find raw-coverage-files -name '*.cobertura.xml' -type f
          echo "Coverage files list: $COVERAGE_FILES"
          echo ""
          echo "Found test result files:"
          find test-results -name '*.trx' -type f
          echo "Test result files list: $TEST_RESULTS_FILES"

      - name: Make startsonar.sh executable
        run: chmod +x ./startsonar.sh

      - name: Start sonar scanning
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          PULL_REQUEST_ID: ${{ inputs.pull-request-id }}
          PULL_REQUEST_SOURCE_BRANCH: ${{ github.ref }}
          PULL_REQUEST_TARGET_BRANCH: refs/heads/master
        shell: bash
        run: ./startsonar.sh

      - name: Build Solution for Metrics
        shell: bash
        run: |
          dotnet build HomeBudgetAccountingApi.sln --no-incremental

      - name: End Sonar scan
        run: dotnet-sonarscanner end /d:sonar.login="$SONAR_TOKEN"
