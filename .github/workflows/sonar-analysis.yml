name: Quality gate - Sonarqube
on:
  workflow_dispatch:
    inputs:
      pull-request-id:
        description: "Pull request id"
        required: false
        type: number
        default: 0
      tests-artifact-path:
        description: "Tests artifact path"
        required: false
        type: string
        default: "merged-coverage"
      tests-artifact-name:
        description: "Tests artifact name"
        required: false
        type: string
        default: "merged-test-coverage-html"
      sonar-scanner-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "5.14.0"
      java-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "21"

  workflow_call:
    inputs:
      pull-request-id:
        description: "Pull request id"
        required: false
        type: number
        default: 0
      tests-artifact-path:
        description: "Tests artifact path"
        required: false
        type: string
        default: "merged-coverage"
      tests-artifact-name:
        description: "Tests artifact name"
        required: false
        type: string
        default: "merged-test-coverage-html"
      sonar-scanner-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "5.14.0"
      java-version:
        description: "Sonar scanner version"
        required: false
        type: string
        default: "21"
    secrets:
      SONAR_TOKEN:
        required: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  sonarqube-scan:
    name: Sonar scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Java for SonarQube
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ inputs.java-version }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Download coverage artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.tests-artifact-name }}
          path: ${{ inputs.tests-artifact-path }}

      - name: Install dotnet tools
        run: |
          dotnet tool install --global dotnet-sonarscanner --version ${{ inputs.sonar-scanner-version }}

      - name: Make the scanner script file executable
        run: |
          chmod +x ./startsonar.sh

      - name: Set GITHUB_REF_NAME
        shell: bash
        run: |
          echo "GITHUB_REF_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Start sonar scanning
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          PULL_REQUEST_ID: ${{ inputs.pull-request-id }}
          PULL_REQUEST_SOURCE_BRANCH: ${{ github.ref }}
          PULL_REQUEST_TARGET_BRANCH: refs/heads/master
        shell: bash
        run: ./startsonar.sh

      - name: Build Solution for Metrics
        shell: bash
        run: |
          dotnet build HomeBudgetAccountingApi.sln --no-incremental

      - name: End Sonar scan
        run: dotnet-sonarscanner end /d:sonar.login="$SONAR_TOKEN"
